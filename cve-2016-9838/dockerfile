FROM ubuntu:18.04
ENV DEBIAN_FRONTEND=noninteractive
RUN set -ex && \
    sed -i "s/security.ubuntu.com/mirrors.aliyun.com/g" /etc/apt/sources.list && \
    sed -i "s/archive.ubuntu.com/mirrors.aliyun.com/g" /etc/apt/sources.list  && \
    apt-get update 
RUN set -ex && \ 
    apt-get install -y php7.2 && \
    apt-get install -y apache2 && \
    apt-get install -y zip && \
    apt-get install -y unzip && \
    apt-get install -y libapache2-mod-php && \
    apt-get install -y mysql-server && \
    apt-get install -y php-xml && \
    apt-get install -y php-mysql
RUN set -ex && \
    apt-get install -y php-dev && \
    apt-get install -y libmcrypt-dev && \
    printf "yes\nyes\n" | pecl install mcrypt-1.0.1 && \
    echo "extension=mcrypt.so" > /etc/php/7.2/mods-available/mcrypt.ini && \
    ln -s /etc/php/7.2/mods-available/mcrypt.ini /etc/php/7.2/apache2/conf.d/20-mcrypt.ini

COPY ./file /file
RUN set -ex && \
    mv /file/run.sh /run.sh && \
    mv /file/Joomla_3.6.4.zip /var/www/ && \
    mv /file/install.sql /install.sql
RUN set -ex && \ 
    chmod +x /run.sh && \
    rm /var/www/html/index.html && \
    unzip /var/www/Joomla_3.6.4.zip -d /var/www/html && \ 
    rm /var/www/Joomla_3.6.4.zip && \ 
    chmod -R 777 /var/www/html
RUN set -ex && mkdir /var/run/mysqld && chmod 777 /var/run/mysqld /var/lib/mysql
RUN set -ex && \
    chown -R mysql:mysql  /var/run/mysqld /var/lib/mysql && \
    service mysql start && \
    mysql -uroot < /install.sql && \
    rm /install.sql
WORKDIR /var/www/html
CMD /bin/bash /run.sh

