FROM ubuntu:18.04

RUN set -ex && \
    sed -i "s/security.ubuntu.com/mirrors.aliyun.com/g" /etc/apt/sources.list && \
    sed -i "s/archive.ubuntu.com/mirrors.aliyun.com/g" /etc/apt/sources.list  && \
    apt-get update
RUN set -ex && apt-get install -y mysql-server && apt-get install -y git
RUN set -ex && mkdir /app
COPY ./gitea  /app/gitea
COPY ./run.sh /run.sh
COPY ./install.sql /install.sql
RUN set -ex && chmod +x /app/gitea && chmod +x /run.sh
RUN set -ex && mkdir /var/run/mysqld && chmod 777 /var/run/mysqld /var/lib/mysql
RUN set -ex && \
    chown -R mysql:mysql  /var/run/mysqld /var/lib/mysql && \
    service mysql start && \
    mysql -uroot < /install.sql
WORKDIR /app
CMD /bin/bash /run.sh
