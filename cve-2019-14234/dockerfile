FROM ubuntu:18.04
ENV DEBIAN_FRONTEND=noninteractive
RUN set -ex && \
    sed -i "s/security.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list && \
    sed -i "s/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list  && \
    apt-get update
RUN set -ex && \ 
    apt-get install -y python3 && \
    apt-get install -y python3-pip && \
    apt-get install -y sudo && \
    apt-get install -y postgresql && \
    apt-get install -y python-psycopg2 && \
    apt-get install -y libpq-dev && \
    apt-get install -y inetutils-ping && \
    apt-get install -y curl
RUN set -ex && \
    pip3 install django==2.2.3 -i  https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip3 install psycopg2 -i  https://pypi.tuna.tsinghua.edu.cn/simple
COPY run.sh /run.sh
COPY app /app
RUN set -ex && chmod +x /run.sh 
WORKDIR /app
RUN set -ex && /etc/init.d/postgresql start && sudo -u postgres psql --command "CREATE DATABASE test_cve;" && sudo -u postgres psql --command "ALTER USER postgres WITH PASSWORD '123456';"
RUN set -ex && \
    /etc/init.d/postgresql restart && \
    python3 manage.py makemigrations cve_2019_14234 && \
    python3 manage.py migrate && \ 
    python3 manage.py shell -c "from cve_2019_14234.models import Json;Json.objects.create(name='001',data={'id':'1'});Json.objects.create(name='002',data={'id':'2'})" && \
    python3 manage.py createsuperuser --username admin --email admin@example.com --noinput && \
    python3 manage.py shell -c "from django.contrib.auth.models import User;user = User.objects.get(username='admin');user.set_password('123456');user.save()"
CMD /run.sh